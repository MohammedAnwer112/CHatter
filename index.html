<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Family Messenger Fix</title>
    <style>
        :root {
            --wa-teal: #008069; --wa-green: #00a884; --wa-light: #dcf8c6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        
        /* Basic Layout Fix */
        html, body { 
            height: 100%; width: 100%; 
            overflow: hidden; position: fixed; 
            background: #d1d7db;
        }

        .app-container { 
            display: flex; width: 100%; height: 100%; 
            background: #f0f2f5; position: relative; 
        }

        /* Hidden class for toggling views */
        .hidden { display: none !important; }

        /* Login Screen */
        .login-screen {
            position: absolute; inset: 0; z-index: 2000;
            background: #f0f2f5; display: flex; align-items: center; justify-content: center;
        }
        .login-card { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* Sidebar (Members) */
        .sidebar {
            width: 280px; background: white; border-right: 1px solid #ddd;
            display: flex; flex-direction: column; transition: 0.3s; z-index: 1000;
        }
        @media (max-width: 768px) {
            .sidebar { position: absolute; left: 0; top: 0; bottom: 0; transform: translateX(-100%); width: 80%; }
            .sidebar.active { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        }

        /* Chat Area */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #efeae2; position: relative; }
        .header { height: 60px; background: #f0f2f5; display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid #ddd; z-index: 10; }
        
        .messages { 
            flex: 1; overflow-y: auto; padding: 15px; 
            display: flex; flex-direction: column; gap: 10px;
        }

        /* Bubbles */
        .bubble { 
            max-width: 85%; padding: 8px 12px; border-radius: 8px; font-size: 16px; 
            position: relative; line-height: 1.4; word-wrap: break-word;
        }
        .sent { align-self: flex-end; background: var(--wa-light); }
        .received { align-self: flex-start; background: white; }

        /* Input Fix for Mobile */
        .input-bar { 
            background: #f0f2f5; padding: 10px; display: flex; align-items: center; gap: 8px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }
        .input-box { flex: 1; background: white; border-radius: 20px; padding: 5px 15px; display: flex; }
        .input-box input { flex: 1; border: none; outline: none; padding: 8px; font-size: 16px; }

        .btn { border: none; background: none; cursor: pointer; font-size: 20px; }
        .send-btn { color: var(--wa-teal); font-weight: bold; }
        
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 998; }
        .overlay.active { display: block; }
    </style>
</head>
<body>

    <div id="login-view" class="login-screen">
        <div class="login-card">
            <h2 style="color:var(--wa-teal); margin-bottom:15px;">Family Chat</h2>
            <input type="text" id="username" placeholder="Your Name" style="width:100%; padding:12px; margin-bottom:15px; border:1px solid #ddd; border-radius:5px;">
            <button onclick="login()" style="width:100%; padding:12px; background:var(--wa-green); color:white; border:none; border-radius:5px; font-weight:bold;">Enter</button>
        </div>
    </div>

    <div id="app-view" class="app-container hidden">
        <div id="overlay" class="overlay" onclick="toggleMenu()"></div>
        
        <aside id="sidebar" class="sidebar">
            <div style="padding:20px; background:#f0f2f5; font-weight:bold; border-bottom:1px solid #ddd;">Family Members</div>
            <div id="member-list" style="flex:1; overflow-y:auto;"></div>
            <button onclick="logout()" style="padding:15px; color:red; border:none; background:none; text-align:left;">Logout</button>
        </aside>

        <main class="chat-area">
            <header class="header">
                <button class="btn" onclick="toggleMenu()" style="margin-right:10px;">â˜°</button>
                <strong id="chat-title">Family Group</strong>
            </header>

            <div id="msg-list" class="messages"></div>

            <div class="input-bar">
                <div class="input-box">
                    <input type="text" id="msg-input" placeholder="Message">
                    <button class="btn" onclick="translateMsg()">ðŸ‡¸ðŸ‡¦</button>
                </div>
                <button id="voice-btn" class="btn" onclick="handleVoice()">ðŸŽ¤</button>
                <button class="btn send-btn" onclick="sendMsg()">âž¤</button>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, onValue, set, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // FIREBASE CONFIG
        const config = {
            apiKey: "AIzaSyAMYdzPOewh_HnJcKVwirNwaCfgK93-pP4",
            databaseURL: "https://family-d6ff1-default-rtdb.firebaseio.com",
            projectId: "family-d6ff1"
        };

        const app = initializeApp(config);
        const db = getDatabase(app);
        let user = localStorage.getItem('fm_user');
        let recorder = null;
        let chunks = [];

        // STARTUP
        if (user) start();

        window.login = () => {
            const name = document.getElementById('username').value.trim();
            if (name) {
                localStorage.setItem('fm_user', name);
                user = name;
                start();
            }
        };

        function start() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');

            // Online Status
            const statusRef = ref(db, 'status/' + user);
            set(statusRef, { name: user, online: true });
            onDisconnect(statusRef).remove();

            // Load Messages
            onChildAdded(ref(db, 'family_messages'), (s) => render(s.val()));

            // Load Members
            onValue(ref(db, 'status'), (s) => {
                const list = document.getElementById('member-list');
                list.innerHTML = '';
                const data = s.val();
                for (let k in data) {
                    list.innerHTML += `<div style="padding:15px; border-bottom:1px solid #f9f9f9;">ðŸŸ¢ ${data[k].name}</div>`;
                }
            });
        }

        window.sendMsg = () => {
            const input = document.getElementById('msg-input');
            if (!input.value.trim()) return;
            push(ref(db, 'family_messages'), {
                sender: user,
                text: input.value,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            });
            input.value = '';
        };

        function render(data) {
            const list = document.getElementById('msg-list');
            const isMe = data.sender === user;
            const div = document.createElement('div');
            div.className = `bubble ${isMe ? 'sent' : 'received'}`;
            div.innerHTML = `
                <small style="display:block; font-weight:bold; color:${isMe ? '#008069' : '#027eb5'}">${data.sender}</small>
                ${data.text || `<audio src="${data.audio}" controls style="width:200px;"></audio>`}
                <span style="font-size:10px; color:#999; float:right; margin-top:5px;">${data.time}</span>
            `;
            list.appendChild(div);
            list.scrollTop = list.scrollHeight;
        }

        window.toggleMenu = () => {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        };

        window.logout = () => {
            localStorage.clear();
            location.reload();
        };

        // SAFETY-GUARDED VOICE
        window.handleVoice = async () => {
            const btn = document.getElementById('voice-btn');
            try {
                if (!recorder || recorder.state === "inactive") {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    recorder = new MediaRecorder(stream);
                    chunks = [];
                    recorder.ondataavailable = e => chunks.push(e.data);
                    recorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            push(ref(db, 'family_messages'), {
                                sender: user,
                                audio: e.target.result,
                                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                            });
                        };
                        reader.readAsDataURL(blob);
                    };
                    recorder.start();
                    btn.innerText = "ðŸ›‘";
                } else {
                    recorder.stop();
                    btn.innerText = "ðŸŽ¤";
                }
            } catch (e) {
                alert("Microphone not available on this device.");
            }
        };

        window.translateMsg = async () => {
            const input = document.getElementById('msg-input');
            if (!input.value) return;
            try {
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(input.value)}&langpair=en|ar`);
                const json = await res.json();
                input.value = json.responseData.translatedText;
            } catch (e) {}
        };

        document.getElementById('msg-input').onkeydown = e => { if(e.key==='Enter') sendMsg(); };
    </script>
</body>
</html>
